<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>All Tickets - CloudKeeper Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #0052CC;
            --secondary-color: #0065FF;
            --cta-color: #00A3BF;
            --text-dark: #172B4D;
            --text-light: #505F79;
            --background-light: #F4F5F7;
            --white: #FFFFFF;
            --border-color: #DFE1E6;
            --success-bg: #E3FCEF;
            --success-text: #006644;
            --info-bg: #DEEBFF;
            --info-text: #0052CC;
            --warning-bg: #FFFAE6;
            --warning-text: #FF8B00;
            --font-family: 'Inter', 'Arial', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--background-light);
        }
        .app-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .app-header { background-color: var(--white); padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-content {
            display: flex; justify-content: space-between; align-items: center;
            max-width: 1200px; margin: 0 auto; padding: 0 20px;
        }
        .app-logo-text { font-size: 1.5em; font-weight: 600; color: var(--text-dark); text-decoration: none; }
        .app-logo-text img { height: 35px; vertical-align: middle; margin-right: 8px; }
        .user-actions a {
            color: var(--text-dark); font-weight: 500; margin-left: 15px;
            text-decoration: none; padding: 8px 12px; border-radius: 6px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .user-actions a:hover { background-color: var(--background-light); color: var(--primary-color); }
        .user-actions .btn-nav { /* More generic class for nav buttons */
            border: 1px solid var(--border-color);
        }
        .user-actions .btn-nav:hover {
             border-color: var(--primary-color);
        }
        .user-actions .btn-logout {
            background-color: var(--primary-color); color: var(--white);
        }
        .user-actions .btn-logout:hover { background-color: var(--secondary-color); border-color: var(--secondary-color); }

        .main-content { padding: 30px 0; }
        .page-title { font-size: 2em; font-weight: 600; color: var(--text-dark); margin-bottom: 20px; }
        .search-bar-container {
            margin-bottom: 25px; display: flex; align-items: center;
            background-color: var(--white); padding: 8px 15px;
            border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        .search-bar-container i { color: var(--text-light); margin-right: 10px; font-size: 1.1em; }
        #searchInput {
            flex-grow: 1; border: none; outline: none;
            padding: 8px 0; font-size: 1em; background-color: transparent;
        }
        #searchInput::placeholder { color: var(--text-light); opacity: 0.8; }
        .table-and-details-wrapper {
            background-color: var(--white); padding: 25px;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        }
        .styled-table {
            width: 100%; border-collapse: collapse; margin-bottom: 30px;
        }
        .styled-table th, .styled-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .styled-table thead th {
            background-color: var(--success-bg); color: var(--success-text);
            font-weight: 600; font-size: 0.9em; text-transform: uppercase;
            letter-spacing: 0.5px; border-bottom: 2px solid var(--primary-color);
        }
        .styled-table tbody tr { cursor: pointer; }
        .styled-table tbody tr:hover { background-color: #f9fafb; }
        .styled-table tbody tr.active-ticket-row { background-color: var(--info-bg); font-weight: 500; }
        .d-none { display: none !important; }
        .ticket-details-card { border: 1px solid var(--border-color); border-radius: 8px; }
        .ticket-details-card .card-header {
            background-color: var(--info-bg); color: var(--info-text);
            padding: 15px 20px; border-bottom: 1px solid var(--border-color);
            border-top-left-radius: inherit; border-top-right-radius: inherit; /* Inherit from parent card */
        }
        .ticket-details-card .card-header h5 { margin: 0; font-size: 1.3em; font-weight: 600; }
        .ticket-details-card .card-body { padding: 20px; }
        .detail-item { display: flex; margin-bottom: 12px; }
        .detail-item strong {
            color: var(--text-dark); min-width: 130px; /* Adjust for alignment */
            font-weight: 600; padding-right: 10px;
        }
        .detail-item span, .detail-item input, .detail-item textarea, .detail-item select {
            flex-grow: 1; color: var(--text-light);
            word-break: break-word;
        }
        .form-control-display { /* For readonly inputs that look like text */
            background-color: transparent;
            border: none;
            padding: 0;
            font-size: inherit;
            color: var(--text-light);
            width: 100%;
            cursor: default;
        }
        .form-control-editable { /* For when inputs are editable */
             display: block; width: 100%; padding: 8px 12px; font-size: 1em;
            color: var(--text-dark); background-color: var(--white);
            border: 1px solid var(--border-color); border-radius: 6px;
        }
        .form-control-editable:focus {
            border-color: var(--primary-color); outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 82, 204, 0.25);
        }

        #screenshotContainer { margin-top: 10px; gap: 10px; }
        .screenshot-img, .remedy-doc-link {
            border: 1px solid var(--border-color); border-radius: 4px;
            object-fit: cover; margin: 5px;
        }
        .screenshot-img { max-width: 180px; max-height: 120px; cursor: pointer; }
        .remedy-doc-link {
            display: inline-block; padding: 8px 12px;
            background-color: var(--background-light);
            color: var(--primary-color); text-decoration: none;
            font-size: 0.9em;
        }
        .remedy-doc-link:hover { background-color: var(--border-color); }
        .btn-action {
            padding: 8px 15px; border-radius: 6px; font-weight: 500;
            border: none; cursor: pointer; margin-left: 10px;
            transition: background-color 0.2s ease;
        }
        .btn-edit { background-color: var(--warning-bg); color: var(--warning-text); border: 1px solid var(--warning-text); }
        .btn-edit:hover { background-color: var(--warning-text); color: var(--white); }
        .btn-save { background-color: var(--success-bg); color: var(--success-text); border: 1px solid var(--success-text); }
        .btn-save:hover { background-color: var(--success-text); color: var(--white); }
        .btn-cancel { background-color: #f8f9fa; color: var(--text-light); border: 1px solid var(--border-color); }
        .btn-cancel:hover { background-color: var(--border-color); }

        .app-footer {
            text-align: center; padding: 20px 0; margin-top: 30px;
            font-size: 0.9em; color: var(--text-light); border-top: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <a href="{{ url_for('home_or_main') }}" class="app-logo-text">
                 <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="CloudKeeper Logo">
            </a>
            <nav class="user-actions">
                <a href="{{ url_for('chatbot_page') }}" class="btn-nav"><i class="fas fa-user-tag"></i>Chat Assisstance</a>

                <a href="{{ url_for('user_ticket_view_page') }}" class="btn-nav"><i class="fas fa-user-tag"></i> Tickets by User</a>
                <a href="{{ url_for('form') }}" class="btn-nav"><i class="fas fa-plus-circle"></i> New Ticket</a>
                <a href="{{ url_for('logout') }}" class="btn-logout">Logout <i class="fas fa-sign-out-alt"></i></a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="app-container">
            <h1 class="page-title">All Submitted Tickets</h1>
            <div id="statusMessages"></div>

            <div class="search-bar-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search by ID, Title, User, Date, Status..." />
            </div>

            <div class="table-and-details-wrapper">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Submitted By</th>
                            <th>Date Submitted</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="ticketTableBody"></tbody>
                </table>

                <div id="ticketDetails" class="ticket-details-card d-none mt-4">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 id="detailTicketIdHeader">Ticket #<span id="detailTicketId"></span></h5>
                    <div>
                        <button id="editBtn" onclick="enableEditMode()" class="btn-action btn-edit"><i class="fas fa-edit"></i> Edit</button>
                        <button id="saveBtn" onclick="saveTicketChanges()" class="btn-action btn-save d-none"><i class="fas fa-save"></i> Save</button>
                        <button id="cancelBtn" onclick="cancelEditMode()" class="btn-action btn-cancel d-none"><i class="fas fa-times"></i> Cancel</button>
                    </div>
                  </div>
                  <div class="card-body">
                    <input type="hidden" id="currentTicketId">
                    <div class="detail-item">
                        <strong>Title:</strong>
                        <input type="text" id="detailTitle" class="form-control-display" readonly>
                    </div>
                    <div class="detail-item">
                        <strong>Description:</strong>
                        <textarea id="detailDescription" class="form-control-display" rows="4" readonly></textarea>
                    </div>
                    <div class="detail-item">
                        <strong>Remedies / Steps:</strong>
                        <textarea id="detailRemedies" class="form-control-display" rows="3" readonly></textarea>
                    </div>
                     <div class="detail-item">
                        <strong>Status:</strong>
                        <select id="detailStatus" class="form-control-display" disabled>
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                            <option value="Pending User">Pending User</option>
                        </select>
                    </div>
                    <div class="detail-item">
                        <strong>Submitted By:</strong>
                        <span id="detailCreatedBy" class="form-control-display"></span>
                    </div>
                    <div class="detail-item">
                        <strong>Date Submitted:</strong>
                        <span id="detailCreatedAt" class="form-control-display"></span>
                    </div>
                    <div id="remedyDocContainer" class="detail-item">
                        <strong>Remedy Document:</strong>
                        <span id="remedyDocLinkContainer">No document attached.</span>
                    </div>
                    <div class="detail-item" style="flex-direction: column; align-items: flex-start;">
                        <strong style="min-width:auto; margin-bottom: 5px;">Screenshots:</strong>
                        <div id="screenshotContainer" class="d-flex flex-wrap">
                            No screenshots attached.
                        </div>
                    </div>
                  </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="app-footer">
        <p>© 2024 CloudKeeper (Team Laadla). All rights reserved.</p>
    </footer>

  <script>
    const ticketTableBody = document.getElementById('ticketTableBody');
    const searchInput = document.getElementById('searchInput');
    const detailSection = document.getElementById('ticketDetails');
    let currentSelectedTicketRow = null;
    let originalTicketData = {}; // To store data for cancel edit

    async function loadTickets(search = '') {
      try {
        const res = await fetch(`/tickets?search=${encodeURIComponent(search)}`);
        if (!res.ok) throw new Error(`HTTP error ${res.status}`);
        const tickets = await res.json();

        ticketTableBody.innerHTML = '';
        if (tickets.length === 0) {
            ticketTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">No tickets found.</td></tr>';
            detailSection.classList.add('d-none');
            return;
        }

        tickets.forEach(ticket => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${ticket.id}</td>
            <td>${ticket.title || 'N/A'}</td>
            <td>${ticket.created_by || 'N/A'}</td>
            <td>${ticket.created_at ? new Date(ticket.created_at).toLocaleDateString() : 'N/A'}</td>
            <td>${ticket.status || 'N/A'}</td>
          `;
          row.onclick = () => {
            if (currentSelectedTicketRow) currentSelectedTicketRow.classList.remove('active-ticket-row');
            row.classList.add('active-ticket-row');
            currentSelectedTicketRow = row;
            showDetails(ticket.id);
          };
          ticketTableBody.appendChild(row);
        });
      } catch (error) {
        console.error('Failed to load tickets:', error);
        ticketTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red; padding: 20px;">Could not load tickets.</td></tr>';
      }
    }

    async function showDetails(id) {
      try {
        const res = await fetch(`/tickets/${id}`);
        if (!res.ok) throw new Error(`HTTP error ${res.status}`);
        const ticket = await res.json();

        if (!ticket) {
            displayStatusMessage('Error: Ticket details not found.', 'error');
            detailSection.classList.add('d-none');
            return;
        }
        originalTicketData = {...ticket}; // Store for cancel

        document.getElementById('currentTicketId').value = ticket.id;
        document.getElementById('detailTicketId').textContent = ticket.id;
        document.getElementById('detailTitle').value = ticket.title || '';
        document.getElementById('detailDescription').value = ticket.description || '';
        document.getElementById('detailRemedies').value = ticket.remedies || '';
        document.getElementById('detailStatus').value = ticket.status || 'Open';
        document.getElementById('detailCreatedBy').textContent = ticket.created_by || 'N/A';
        document.getElementById('detailCreatedAt').textContent = ticket.created_at ? new Date(ticket.created_at).toLocaleString() : 'N/A';

        const screenshotContainer = document.getElementById('screenshotContainer');
        screenshotContainer.innerHTML = '';
        if (ticket.file_path && Array.isArray(ticket.file_path) && ticket.file_path.length > 0 && ticket.file_path[0] !== "") {
          ticket.file_path.forEach(path => {
            if(path.trim()){
              const img = document.createElement('img');
              img.src = `/${path.trim()}`; // Path from server is like 'uploads/filename.png'
              img.className = 'screenshot-img';
              img.alt = 'Screenshot';
              img.onerror = () => { img.style.display='none'; console.warn(`Failed to load image: /${path.trim()}`); };
              screenshotContainer.appendChild(img);
            }
          });
        }
        if(screenshotContainer.childElementCount === 0) {
            screenshotContainer.innerHTML = '<span class="text-muted">No screenshots attached.</span>';
        }

        const remedyDocLinkContainer = document.getElementById('remedyDocLinkContainer');
        if (ticket.remedy_doc_path) {
            const remedyLink = document.createElement('a');
            remedyLink.href = `/${ticket.remedy_doc_path}`;
            remedyLink.textContent = ticket.remedy_doc_path.split('/').pop(); // Show filename
            remedyLink.target = "_blank";
            remedyLink.className = "remedy-doc-link";
            remedyDocLinkContainer.innerHTML = ''; // Clear previous
            remedyDocLinkContainer.appendChild(remedyLink);
        } else {
            remedyDocLinkContainer.innerHTML = '<span class="text-muted">No remedy document attached.</span>';
        }


        setEditMode(false); // Start in read-only mode
        detailSection.classList.remove('d-none');
      } catch (error) {
          console.error('Failed to show ticket details:', error);
          displayStatusMessage(`Error loading ticket details: ${error.message}`, 'error');
          detailSection.classList.add('d-none');
      }
    }

    function setEditMode(isEditing) {
        const fields = ['detailTitle', 'detailDescription', 'detailRemedies'];
        fields.forEach(id => {
            const el = document.getElementById(id);
            el.readOnly = !isEditing;
            el.classList.toggle('form-control-display', !isEditing);
            el.classList.toggle('form-control-editable', isEditing);
        });
        const statusSelect = document.getElementById('detailStatus');
        statusSelect.disabled = !isEditing;
        statusSelect.classList.toggle('form-control-display', !isEditing);
        statusSelect.classList.toggle('form-control-editable', isEditing);


        document.getElementById('editBtn').classList.toggle('d-none', isEditing);
        document.getElementById('saveBtn').classList.toggle('d-none', !isEditing);
        document.getElementById('cancelBtn').classList.toggle('d-none', !isEditing);
    }

    function enableEditMode() {
        setEditMode(true);
    }

    function cancelEditMode() {
        // Revert to original data
        document.getElementById('detailTitle').value = originalTicketData.title || '';
        document.getElementById('detailDescription').value = originalTicketData.description || '';
        document.getElementById('detailRemedies').value = originalTicketData.remedies || '';
        document.getElementById('detailStatus').value = originalTicketData.status || 'Open';
        setEditMode(false);
    }

    async function saveTicketChanges() {
      const id = document.getElementById('currentTicketId').value;
      const updatedData = {
        title: document.getElementById('detailTitle').value,
        description: document.getElementById('detailDescription').value,
        remedies: document.getElementById('detailRemedies').value,
        status: document.getElementById('detailStatus').value
        // created_by and created_at are not typically updated by users here
      };

      try {
        const res = await fetch(`/tickets/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData)
        });

        if (res.ok) {
          const result = await res.json();
          displayStatusMessage(result.message || 'Ticket updated successfully!', 'success');
          setEditMode(false);
          loadTickets(searchInput.value); // Refresh the list to show updated status/title
          // Re-fetch and show details for the current ticket to reflect changes immediately if needed
          // showDetails(id); // This might be redundant if loadTickets selection handles it
        } else {
          const errorResult = await res.json().catch(() => ({error: 'Failed to update ticket.'}));
          displayStatusMessage(`Error: ${errorResult.error || 'Failed to update ticket.'}`, 'error');
        }
      } catch (error) {
        console.error('Error saving ticket:', error);
        displayStatusMessage(`Error saving ticket: ${error.message}`, 'error');
      }
    }

    function displayStatusMessage(message, type = 'info') {
        const statusDiv = document.getElementById('statusMessages');
        statusDiv.innerHTML = `<div class="alert alert-${type === 'error' ? 'danger' : type}" role="alert">${message}</div>`;
        setTimeout(() => { statusDiv.innerHTML = ''; }, 5000); // Message disappears after 5 seconds
    }

    let searchTimeout;
    searchInput.addEventListener('input', e => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadTickets(e.target.value.trim());
            detailSection.classList.add('d-none');
            if(currentSelectedTicketRow) currentSelectedTicketRow.classList.remove('active-ticket-row');
            currentSelectedTicketRow = null;
        }, 300);
    });

    loadTickets();
  </script>
</body>
</html>